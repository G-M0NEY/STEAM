<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Holiday Game!</title>
    <script src="https://unpkg.com/kaboom@2000.0.0-beta.24/dist/kaboom.js"></script>
    <style></style>
  </head>
  <body>
    <script src="https://unpkg.com/kaboom/dist/kaboom.js"></script>

    <script type="module">
      // import kaboom lib
      // import kaboom from "https://unpkg.com/kaboom/dist/kaboom.mjs";

      kaboom({
        global: true,
        fullscreen: true,
        scale: 1,
        debug: true,
        clearColor: [0, 0, 0, 1],
      });

      // load assets
      loadSprite(
        "bg",
        "https://media.istockphoto.com/vectors/seamless-winter-landscape-with-rocky-mountains-for-christmas-game-vector-id497419980?b=1&k=20&m=497419980&s=170667a&w=0&h=uWDAASbieD436NLrQUKIUswjTCJHpvOWY2dwactxAMI="
      );
      loadSprite("santa", "./media/santa1.png");
      loadSprite("ground", "./media/ground1.png");
      loadSprite("coin", "./media/mistletoe.png");
      loadSprite("prize", "./media/present.png");
      loadSprite("spike", "./media/spike1.png");
      loadSprite("apple", "./media/cookie.png");
      loadSprite("ghosty", "./media/grinch.png");
      loadSprite("portal", "./media/portal.png");
      loadSprite("block", "./media/ground2.png");
	  loadSprite("key", "./media/tree.png");
	  loadSprite("door", "./media/door1.png")
      // loadSound("powerup", "/sounds/powerup.mp3")
      // loadSound("blip", "/sounds/blip.mp3")
      // loadSound("hit", "/sounds/hit.mp3")
      // loadSound("portal", "/sounds/portal.mp3")

      // custom component controlling enemy patrol movement
      function patrol(speed = 60, dir = 1) {
        return {
          id: "patrol",
          require: ["pos", "area"],
          add() {
            this.on("collide", (obj, col) => {
              if (col.isLeft() || col.isRight()) {
                dir = -dir;
              }
            });
          },
          update() {
            this.move(speed * dir, 0);
          },
        };
      }

    
      // custom component that makes stuff grow big
    function big() {
    let timer = 0
    let isBig = false
    return {
      update() {
        if (isBig) {
          CURRENT_JUMP_FORCE = BIG_JUMP_FORCE
          timer -= dt()
          if (timer <= 0) {
            this.smallify()
          }
        }
      },
      isBig() {
        return isBig
      },
      smallify() {
        this.scale = vec2(1)
        CURRENT_JUMP_FORCE = JUMP_FORCE
        timer = 0
        isBig = false
      },
      biggify(time) {
        CURRENT_JUMP_FORCE = BIG_JUMP_FORCE
        this.scale = vec2(3)
        timer = time
        isBig = true     
      }
    }
  }

      // define some constants
      const JUMP_FORCE = 1400;
      const MOVE_SPEED = 480;
      const FALL_DEATH = 2400;
      const BIG_JUMP_FORCE = 2000;
      let CURRENT_JUMP_FORCE = JUMP_FORCE;

      const LEVELS = [
        [
          "-                              - ",
          "-                              - ",
          "- *                            - ",
          "-                             $- ",
          "- ===                         $- ",
          "-              $$             $- ",
          "-            ====             $- ",
          "-     %                   -   $- ",
          "-                         -  |-- ",
          "-        ^         - >    - |  @- ",
          "=================================",
        ],
        [

          "                                 ",
          "                                 ",
          "-          $    $    $    $     $",
          "-          $    $    $    $     $",
          "-                                ",
          "-                                ",
          "-           =     =     =        ",
          "-                                ",
          "-       -  >^^^ >^^^ >^^^ >^^^  @",
          "=================================",
        ],
      ];

      // define what each symbol means in the level graph
      const levelConf = {
        // grid size
        width: 100,
        height: 100,
        // define each object as a list of components
        "=": () => [sprite("ground"), area(), solid(), origin("bot")],
		"-": () => [sprite("block"), area(), solid(), origin("bot")],
	    	"|": () => [sprite("door"), area(), solid(), "door"],
        "$": () => [sprite("coin"), area(), pos(0, -9), origin("bot"), "coin"],
        "%": () => [sprite("prize"), area(), solid(), origin("bot"), "prize"],
        "^": () => [sprite("spike"), area(), solid(), origin("bot"), "danger"],
        "#": () => [sprite("apple"), area(), origin("bot"), body(), "apple"],
        ">": () => [
          sprite("ghosty"),
          area(),
          origin("bot"),
          body(),
          patrol(),
          "enemy",
        ],
        "@": () => [
          sprite("portal"),
          area({ scale: 0.5 }),
          origin("bot"),
          pos(0, 0),
          "portal",
        ],
		"*": () => [
			sprite("key"),
			area(),
			"key",
		]
      };

      
      scene("game", ({ levelId, coins } = { levelId: 0, coins: 0 }) => {
        layers(["bg", "obj", "ui"], "obj");
        gravity(3200);

        add([sprite("bg"), scale(12, 6), pos(-800, -500)]);

        // add([
        //   rect(1920, 1080),
        //   color(0, 0, 2),
        //   pos(0, 0, 1)
        // ]);
        // add level to scene
        const level = addLevel(LEVELS[levelId ?? 0], levelConf);

        // define player object
        const player = add([
          sprite("santa"),
          pos(100, 800),
          area(),
          scale(1),
          // makes it fall to gravity and jumpable
          body(),
          // the custom component we defined above
          big(),
          origin("bot"),
        ]);

        // action() runs every frame
        player.onUpdate(() => {
          // center camera to player
          camPos(player.pos);
          // check fall death
          if (player.pos.y >= FALL_DEATH) {
            go("lose");
          }
        });

        // if player onCollide with any obj with "danger" tag, lose
        player.onCollide("danger", () => {
          go("lose");
        });

		let hasKey = false

		player.onCollide("key", (key) => {
			destroy(key)
			hasKey = true
		})
    player.onCollide("door", (d) => {
		if (hasKey) {
        destroy(d)
		}
	})

        player.onCollide("portal", () => {
          if (levelId + 1 < LEVELS.length) {
            go("game", {
              levelId: levelId + 1,
              coins: coins,
            });
          } else {
            go("win");
          }
        });

        player.onGround((l) => {
          if (l.is("enemy")) {
            player.jump(JUMP_FORCE * 1.5);
            destroy(l);
            addKaboom(player.pos);
          }
        });

        player.onCollide("enemy", (e, col) => {
          // if it's not from the top, die
          if (!col.isBottom()) {
            go("lose");
          }
        });

        let hasApple = false;

        // grow an apple if player's head bumps into an obj with "prize" tag
        player.onHeadbutt((obj) => {
          if (obj.is("prize") && !hasApple) {
            const apple = level.spawn("#", obj.gridPos.sub(0, 1));
            apple.jump();
            hasApple = true;
          }
        });

        // player grows big onCollide with an "apple" obj
        player.onCollide("apple", (a) => {
          destroy(a);
          // as we defined in the big() component
          player.biggify(3);
          hasApple = false;
        });

        let coinPitch = 0;

        onUpdate(() => {
          if (coinPitch > 0) {
            coinPitch = Math.max(0, coinPitch - dt() * 100);
          }
        });

        player.onCollide("coin", (c) => {
          destroy(c);
          coinPitch += 100;
          coins += 1;
          coinsLabel.text = coins;
        });

        const coinsLabel = add([text(coins), pos(24, 24), fixed()]);

        // jump with space
        onKeyPress("space", () => {
          // these 2 functions are provided by body() component
          if (player.isGrounded()) {
            player.jump(JUMP_FORCE);
          }
        });

        onKeyDown("left", () => {
          player.move(-MOVE_SPEED, 0);
        });

        onKeyDown("right", () => {
          player.move(MOVE_SPEED, 0);
        });

        onKeyPress("down", () => {
          player.weight = 3;
        });

        onKeyRelease("down", () => {
          player.weight = 1;
        });

        onKeyPress("f", () => {
          fullscreen(!fullscreen());
        });
      });

      // scene("menu", () => {
      //   add([])
      // }
      scene("lose", () => {
        add([text("You Lose")]);
        onKeyPress(() => go("game"));
      });

      scene("win", () => {
        add([text("You Win")]);
        onKeyPress(() => go("game"));
      });

      go("game"); 
    </script>
  </body>
</html>
